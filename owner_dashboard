<?php
require 'db_connect.php';
session_start();

// ========== EMPLOYEE/ADMIN MANAGEMENT ==========
// Update employee info
if (isset($_POST['update_employee'])) {
    $stmt = $conn->prepare("UPDATE employees SET name=?, email=?, role=? WHERE id=?");
    $stmt->bind_param("sssi", $_POST['name'], $_POST['email'], $_POST['role'], $_POST['id']);
    $stmt->execute();
    $stmt->close();
}

// Delete employee
if (isset($_POST['delete_employee'])) {
    $stmt = $conn->prepare("DELETE FROM employees WHERE id=?");
    $stmt->bind_param("i", $_POST['id']);
    $stmt->execute();
    $stmt->close();
}

// ========== INVENTORY MANAGEMENT ==========
// Add/remove inventory
if (isset($_POST['update_inventory'])) {
    $product_id = intval($_POST['product_id']);
    $action = $_POST['action'];
    $amount = intval($_POST['amount']);

    if ($action === 'add') {
        $stmt = $conn->prepare("UPDATE products SET quantity = quantity + ? WHERE id = ?");
    } else {
        $stmt = $conn->prepare("UPDATE products SET quantity = GREATEST(quantity - ?, 0) WHERE id = ?");
    }

    if ($stmt) {
        $stmt->bind_param("ii", $amount, $product_id);
        $stmt->execute();
        $stmt->close();
    } else {
        die("Inventory update failed: " . $conn->error);
    }
}

// ========== DATA FETCHING ==========
$employees = $conn->query("SELECT * FROM employees");
$inventory = $conn->query("SELECT * FROM products");
$sales = $conn->query("SELECT * FROM cart");

$total_sales = 0;
$item_sales = [];

while ($row = $sales->fetch_assoc()) {
    $total_sales += $row['total'];
    $item = $row['product_name'];
    $qty = $row['quantity'];

    if (!isset($item_sales[$item])) $item_sales[$item] = 0;
    $item_sales[$item] += $qty;
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Owner Dashboard - Azalea Haven</title>
    <style>
        body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; }
        h1, h2, h3 { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        form { margin-bottom: 15px; }
        input, select, button { margin: 5px; padding: 7px; }
        .section { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
        .shortcut-btns a button { margin-right: 10px; }
    </style>
</head>
<body>

<h1>ðŸŒ¸ Owner Dashboard - Azalea Haven ðŸŒ¸</h1>

<!-- SHORTCUT LINKS -->
<div class="section shortcut-btns">
    <h2>ðŸ”§ Owner Actions</h2>
    <a href="inventory_management.php">
        <button>âž• Add or Manage Products</button>
    </a>
    <a href="owner_hire.php">
        <button>ðŸ‘¤ Hire New Employee/Admin</button>
    </a>
</div>

<!-- EMPLOYEE/ADMIN MANAGEMENT -->
<div class="section">
    <h2>ðŸ‘¥ Staff Management</h2>
    <?php while ($emp = $employees->fetch_assoc()): ?>
        <form method="POST">
            <input type="hidden" name="id" value="<?= $emp['id'] ?>">
            <input type="text" name="name" value="<?= htmlspecialchars($emp['name']) ?>" required>
            <input type="email" name="email" value="<?= htmlspecialchars($emp['email']) ?>" required>
            <select name="role">
                <option value="employee" <?= $emp['role'] == 'employee' ? 'selected' : '' ?>>Employee</option>
                <option value="admin" <?= $emp['role'] == 'admin' ? 'selected' : '' ?>>Admin</option>
            </select>
            <button type="submit" name="update_employee">Update</button>
            <button type="submit" name="delete_employee" onclick="return confirm('Are you sure?')">Remove</button>
        </form>
    <?php endwhile; ?>
</div>

<!-- INVENTORY MANAGEMENT -->
<div class="section">
    <h2>ðŸ“¦ Inventory Management</h2>
    <?php foreach ($inventory as $item): ?>
        <form method="POST">
            <strong><?= htmlspecialchars($item['name']) ?> â€” Qty: <?= $item['quantity'] ?></strong>
            <input type="hidden" name="product_id" value="<?= $item['id'] ?>">
            <input type="number" name="amount" value="1" min="1" required>
            <select name="action">
                <option value="add">Add</option>
                <option value="remove">Remove</option>
            </select>
            <button type="submit" name="update_inventory">Update</button>
        </form>
    <?php endforeach; ?>
</div>

<!-- SALES SUMMARY -->
<div class="section">
    <h2>ðŸ’° Financial Summary</h2>
    <p><strong>Total Profit:</strong> $<?= number_format($total_sales, 2) ?></p>

    <h3>Items Sold</h3>
    <table>
        <tr><th>Product</th><th>Quantity Sold</th></tr>
        <?php foreach ($item_sales as $name => $qty): ?>
        <tr><td><?= htmlspecialchars($name) ?></td><td><?= $qty ?></td></tr>
        <?php endforeach; ?>
    </table>
</div>

<a href="LandingPage.html">â¬… Back to Home</a>

</body>
</html>
